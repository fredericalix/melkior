# Architecture Diagrams

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Node Status Platform                            │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        Sensor Layer                               │ │
│  │                                                                   │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │ │
│  │  │  HTTP    │  │  System  │  │  Docker  │  │  Custom  │        │ │
│  │  │  Sensor  │  │  Sensor  │  │  Sensor  │  │  Sensor  │        │ │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │ │
│  │       │             │             │             │                │ │
│  │       └─────────────┴─────────────┴─────────────┘                │ │
│  │                         │                                        │ │
│  │                    [gRPC Protocol]                               │ │
│  └───────────────────────┼───────────────────────────────────────┘ │
│                           │                                          │
│  ┌────────────────────────▼────────────────────────────────────────┐ │
│  │                     Backend Services                            │ │
│  │                                                                 │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │ │
│  │  │     Auth     │  │   Node       │  │    Event     │        │ │
│  │  │ Interceptor  │─▶│   Service    │─▶│   Broker     │        │ │
│  │  └──────────────┘  └──────┬───────┘  └──────────────┘        │ │
│  │                            │                                    │ │
│  │  ┌─────────────────────────▼────────────────────────┐         │ │
│  │  │              Redis Storage Layer                  │         │ │
│  │  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐ │         │ │
│  │  │  │  Hash  │  │  Sets  │  │ Sorted │  │ Stream │ │         │ │
│  │  │  │ (Data) │  │(Index) │  │  Sets  │  │(Events)│ │         │ │
│  │  │  └────────┘  └────────┘  └────────┘  └────────┘ │         │ │
│  │  └──────────────────────────────────────────────────┘         │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                      Client Applications                       │ │
│  │                                                                │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │ │
│  │  │  nodectl │  │ demo-sim │  │ Dashboard│  │Monitoring│     │ │
│  │  │   (CLI)  │  │  (Load)  │  │   (UI)   │  │  Tools   │     │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      Data Flow Sequence                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. CREATE/UPDATE Flow                                         │
│  ═══════════════════════                                       │
│                                                                 │
│     Sensor          Backend           Redis                   │
│       │                │                │                      │
│       ├──[gRPC]───────▶│                │                      │
│       │  CreateNode    │                │                      │
│       │                ├──[Validate]    │                      │
│       │                │                │                      │
│       │                ├───[HSET]──────▶│ node:{id}           │
│       │                │                │                      │
│       │                ├───[SADD]──────▶│ nodes:all           │
│       │                │                │                      │
│       │                ├───[SADD]──────▶│ nodes:type:{type}   │
│       │                │                │                      │
│       │                ├───[SADD]──────▶│ nodes:status:{stat} │
│       │                │                │                      │
│       │                ├───[XADD]──────▶│ nodes:events        │
│       │                │                │                      │
│       │◀─[Response]────┤                │                      │
│       │   Node ID      │                │                      │
│       │                │                │                      │
│                                                                 │
│  2. QUERY Flow                                                 │
│  ═════════════                                                 │
│                                                                 │
│     Client         Backend           Redis                     │
│       │                │                │                      │
│       ├──[gRPC]───────▶│                │                      │
│       │  ListNodes     │                │                      │
│       │                ├───[SMEMBERS]──▶│ nodes:type:VM       │
│       │                │◀──[IDs]────────┤                      │
│       │                │                │                      │
│       │                ├───[HGETALL]───▶│ node:{id1}          │
│       │                │◀──[Data]───────┤                      │
│       │                │                │                      │
│       │                ├───[HGETALL]───▶│ node:{id2}          │
│       │                │◀──[Data]───────┤                      │
│       │                │                │                      │
│       │◀─[Response]────┤                │                      │
│       │   Node List    │                │                      │
│       │                │                │                      │
│                                                                 │
│  3. EVENT STREAM Flow                                          │
│  ════════════════════                                          │
│                                                                 │
│     Watcher        Backend         Redis          Broker       │
│       │                │             │              │          │
│       ├──[gRPC]───────▶│             │              │          │
│       │  WatchEvents   │             │              │          │
│       │                ├─[Subscribe]─┼──────────────▶          │
│       │                │             │              │          │
│       │                ├──[XREAD]───▶│              │          │
│       │                │◀─[Events]───┤              │          │
│       │                │             │              │          │
│       │                ├─[Publish]───┼─────────────▶│          │
│       │                │             │              │          │
│       │◀──[Stream]─────┼─────────────┼──────────────┤          │
│       │   Events       │             │              │          │
│       │                │             │              │          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Redis Data Schema

```
┌─────────────────────────────────────────────────────────────────┐
│                     Redis Data Structure                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Primary Storage (HASH)                                        │
│  ══════════════════════                                        │
│                                                                 │
│  node:550e8400-e29b-41d4                                       │
│  ┌─────────────────────────────────────────────┐               │
│  │ id          │ 550e8400-e29b-41d4            │               │
│  │ type        │ 2 (VM)                        │               │
│  │ name        │ production-web-01              │               │
│  │ status      │ 2 (UP)                         │               │
│  │ last_seen   │ 2024-01-15T10:00:00Z          │               │
│  │ labels_json │ {"env":"prod","service":"web"} │               │
│  │ metadata    │ {"cpu":8,"ram":32}             │               │
│  └─────────────────────────────────────────────┘               │
│                                                                 │
│  Name Index (STRING)                                            │
│  ═══════════════════                                           │
│                                                                 │
│  node:byname:2:production-web-01 → "550e8400-e29b-41d4"       │
│                                                                 │
│  Type/Status Indexes (SETS)                                    │
│  ═══════════════════════════                                   │
│                                                                 │
│  nodes:all          → {id1, id2, id3, ...}                     │
│  nodes:type:1       → {baremetal_ids...}                       │
│  nodes:type:2       → {vm_ids...}                              │
│  nodes:type:3       → {container_ids...}                       │
│  nodes:status:1     → {unknown_ids...}                         │
│  nodes:status:2     → {up_ids...}                              │
│  nodes:status:3     → {down_ids...}                            │
│  nodes:status:4     → {degraded_ids...}                        │
│                                                                 │
│  Event Stream (STREAM)                                         │
│  ═════════════════════                                         │
│                                                                 │
│  nodes:events                                                  │
│  ┌──────────────────────────────────────────┐                 │
│  │ ID: 1610712345678-0                      │                 │
│  │ ├─ event_type: 1 (CREATED)               │                 │
│  │ ├─ node_id: 550e8400-e29b-41d4           │                 │
│  │ ├─ changed_fields: []                    │                 │
│  │ └─ ts: 1610712345                        │                 │
│  ├──────────────────────────────────────────┤                 │
│  │ ID: 1610712355678-0                      │                 │
│  │ ├─ event_type: 2 (UPDATED)               │                 │
│  │ ├─ node_id: 550e8400-e29b-41d4           │                 │
│  │ ├─ changed_fields: ["status"]            │                 │
│  │ └─ ts: 1610712355                        │                 │
│  └──────────────────────────────────────────┘                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Sensor Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│                      Sensor Lifecycle                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. INITIALIZATION                                             │
│  ═════════════════                                             │
│                                                                 │
│     ┌──────────┐                                               │
│     │  Start   │                                               │
│     └────┬─────┘                                               │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐     ┌──────────┐                             │
│     │  Load    │────▶│  Parse   │                             │
│     │  Config  │     │  Flags   │                             │
│     └────┬─────┘     └──────────┘                             │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐     ┌──────────┐                             │
│     │ Connect  │────▶│   Auth   │                             │
│     │   gRPC   │     │  Token   │                             │
│     └────┬─────┘     └──────────┘                             │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐                                               │
│     │ Register │                                               │
│     │   Node   │                                               │
│     └────┬─────┘                                               │
│          │                                                      │
│                                                                 │
│  2. MONITORING LOOP                                            │
│  ══════════════════                                            │
│                                                                 │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐                                               │
│  ┌─▶│  Timer   │                                               │
│  │  │   Wait   │                                               │
│  │  └────┬─────┘                                               │
│  │       │                                                      │
│  │       ▼                                                      │
│  │  ┌──────────┐     ┌──────────┐     ┌──────────┐          │
│  │  │  Check   │────▶│ Evaluate │────▶│  Update  │          │
│  │  │  Health  │     │  Status  │     │  Backend │          │
│  │  └──────────┘     └──────────┘     └────┬─────┘          │
│  │                                          │                  │
│  │       ┌──────────┐                       │                  │
│  │       │  Error   │◀──────────────────────┤                  │
│  │       │  Handle  │                       │                  │
│  │       └────┬─────┘                       │                  │
│  │            │                             │                  │
│  └────────────┴─────────────────────────────┘                  │
│                                                                 │
│  3. SHUTDOWN                                                   │
│  ═══════════                                                   │
│                                                                 │
│     ┌──────────┐                                               │
│     │  Signal  │                                               │
│     │ SIGTERM  │                                               │
│     └────┬─────┘                                               │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐     ┌──────────┐                             │
│     │   Stop   │────▶│  Close   │                             │
│     │  Monitor │     │Connection│                             │
│     └────┬─────┘     └──────────┘                             │
│          │                                                      │
│          ▼                                                      │
│     ┌──────────┐                                               │
│     │   Exit   │                                               │
│     └──────────┘                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Event Processing Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│                   Event Processing Pipeline                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Event Source ──▶ Validation ──▶ Storage ──▶ Fan-out          │
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                   Event Sources                      │      │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │      │
│  │  │  Create  │  │  Update  │  │  Delete  │          │      │
│  │  │Operation │  │Operation │  │Operation │          │      │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘          │      │
│  │       └──────────────┴──────────────┘                │      │
│  └───────────────────────┬──────────────────────────────┘      │
│                          │                                      │
│                          ▼                                      │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                  Validation Layer                    │      │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │      │
│  │  │  Schema  │  │  Auth    │  │Business  │          │      │
│  │  │  Valid   │  │  Check   │  │  Rules   │          │      │
│  │  └──────────┘  └──────────┘  └──────────┘          │      │
│  └───────────────────────┬──────────────────────────────┘      │
│                          │                                      │
│                          ▼                                      │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                   Storage Layer                      │      │
│  │                                                      │      │
│  │     ┌─────────────────────────────┐                 │      │
│  │     │     Atomic Transaction      │                 │      │
│  │     │  ┌────────┐  ┌────────┐    │                 │      │
│  │     │  │ Update │  │ Update │    │                 │      │
│  │     │  │  Hash  │  │ Indexes│    │                 │      │
│  │     │  └────────┘  └────────┘    │                 │      │
│  │     │  ┌────────────────────┐    │                 │      │
│  │     │  │  Append to Stream  │    │                 │      │
│  │     │  └────────────────────┘    │                 │      │
│  │     └─────────────────────────────┘                 │      │
│  └───────────────────────┬──────────────────────────────┘      │
│                          │                                      │
│                          ▼                                      │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                    Fan-out Layer                     │      │
│  │                                                      │      │
│  │     ┌────────────────────────────────┐              │      │
│  │     │        Event Broker            │              │      │
│  │     │  ┌──────────────────────┐      │              │      │
│  │     │  │   Subscriber List    │      │              │      │
│  │     │  ├──────────────────────┤      │              │      │
│  │     │  │ Client A │ Channel A │      │              │      │
│  │     │  │ Client B │ Channel B │      │              │      │
│  │     │  │ Client C │ Channel C │      │              │      │
│  │     │  └──────────────────────┘      │              │      │
│  │     └────────────────────────────────┘              │      │
│  │                                                      │      │
│  │     Broadcast to all subscribers                    │      │
│  │     ┌────────┐  ┌────────┐  ┌────────┐            │      │
│  │     │Client A│  │Client B│  │Client C│            │      │
│  │     └────────┘  └────────┘  └────────┘            │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                   Production Deployment                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │                   Load Balancer                       │     │
│  │                  (nginx/HAProxy)                      │     │
│  └─────────────┬───────────────┬─────────────────────────┘     │
│                │               │                                │
│         ┌──────▼──────┐ ┌─────▼──────┐                        │
│         │   Backend   │ │  Backend   │                        │
│         │  Instance 1 │ │ Instance 2 │                        │
│         │   (Active)  │ │  (Active)  │                        │
│         └──────┬──────┘ └─────┬──────┘                        │
│                │               │                                │
│         ┌──────┴───────────────┴──────┐                        │
│         │                             │                        │
│  ┌──────▼──────┐            ┌────────▼────────┐               │
│  │Redis Master │            │ Redis Replica 1 │               │
│  │  (Primary)  │◀───────────│   (Read-only)   │               │
│  └──────┬──────┘            └─────────────────┘               │
│         │                                                       │
│         │                   ┌─────────────────┐               │
│         └──────────────────▶│ Redis Replica 2 │               │
│                             │   (Read-only)   │               │
│                             └─────────────────┘               │
│                                                                 │
│  Monitoring & Observability                                    │
│  ═══════════════════════════                                   │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │Prometheus│  │ Grafana  │  │  Jaeger  │  │   ELK    │     │
│  │ Metrics  │  │Dashboard │  │  Tracing │  │  Logging │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     Security Layers                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Network Security                                           │
│  ═══════════════════                                           │
│     ┌─────────────┐                                            │
│     │   Firewall  │ ◀── Allow: 50051, 8080                    │
│     └──────┬──────┘     Block: All other                      │
│            │                                                    │
│            ▼                                                    │
│     ┌─────────────┐                                            │
│     │  TLS/SSL    │ ◀── Certificate validation                │
│     └──────┬──────┘                                            │
│            │                                                    │
│                                                                 │
│  2. Authentication                                             │
│  ═════════════════                                             │
│            │                                                    │
│            ▼                                                    │
│     ┌─────────────┐     ┌─────────────┐                      │
│     │   gRPC      │────▶│   Token     │                      │
│     │  Metadata   │     │ Validation  │                      │
│     └─────────────┘     └──────┬──────┘                      │
│                                │                               │
│                                ▼                               │
│                         Bearer Token                           │
│                    "Authorization: Bearer                      │
│                     <ADMIN_TOKEN>"                             │
│                                                                 │
│  3. Authorization                                              │
│  ════════════════                                              │
│                                │                               │
│                                ▼                               │
│     ┌─────────────────────────────────────────┐               │
│     │         Method Authorization            │               │
│     │  ┌─────────────────────────────────┐    │               │
│     │  │ Mutating Operations:            │    │               │
│     │  │ • CreateNode    ✓ Auth Required │    │               │
│     │  │ • UpdateNode    ✓ Auth Required │    │               │
│     │  │ • DeleteNode    ✓ Auth Required │    │               │
│     │  ├─────────────────────────────────┤    │               │
│     │  │ Read Operations:                │    │               │
│     │  │ • GetNode       ✗ No Auth       │    │               │
│     │  │ • ListNodes     ✗ No Auth       │    │               │
│     │  │ • WatchEvents   ✗ No Auth       │    │               │
│     │  └─────────────────────────────────┘    │               │
│     └─────────────────────────────────────────┘               │
│                                                                 │
│  4. Audit Logging                                              │
│  ════════════════                                              │
│                                │                               │
│                                ▼                               │
│     ┌─────────────────────────────────────────┐               │
│     │          Audit Log Entry                │               │
│     │  ┌───────────────────────────────┐      │               │
│     │  │ Timestamp: 2024-01-15T10:00:00 │      │               │
│     │  │ Method: CreateNode             │      │               │
│     │  │ User: token:****3a4b           │      │               │
│     │  │ Result: SUCCESS                │      │               │
│     │  │ Node: 550e8400-e29b-41d4       │      │               │
│     │  └───────────────────────────────┘      │               │
│     └─────────────────────────────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Scale Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Scaling Strategies                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Horizontal Scaling (10K+ Nodes)                               │
│  ════════════════════════════════                              │
│                                                                 │
│     ┌─────────────────────────────────────┐                   │
│     │      Geographic Distribution         │                   │
│     │  ┌─────────┐  ┌─────────┐  ┌─────────┐                │
│     │  │Region 1 │  │Region 2 │  │Region 3 │                │
│     │  │US-East  │  │EU-West  │  │AP-South │                │
│     │  └────┬────┘  └────┬────┘  └────┬────┘                │
│     │       │            │            │                        │
│     │  ┌────▼────────────▼────────────▼────┐                 │
│     │  │    Global Redis Cluster            │                 │
│     │  │   (Cross-Region Replication)       │                 │
│     │  └────────────────────────────────────┘                 │
│     └─────────────────────────────────────┘                   │
│                                                                 │
│  Sensor Scaling (1000+ Sensors)                                │
│  ═══════════════════════════════                              │
│                                                                 │
│     ┌─────────────────────────────────────┐                   │
│     │         Sensor Aggregation           │                   │
│     │  ┌─────────────────────────────┐     │                   │
│     │  │    Regional Aggregators     │     │                   │
│     │  │  ┌──────┐  ┌──────┐  ┌──────┐   │                   │
│     │  │  │Agg 1 │  │Agg 2 │  │Agg 3 │   │                   │
│     │  │  │100   │  │100   │  │100   │   │                   │
│     │  │  │nodes │  │nodes │  │nodes │   │                   │
│     │  │  └──────┘  └──────┘  └──────┘   │                   │
│     │  │       Batch updates to backend    │                   │
│     │  └─────────────────────────────┘     │                   │
│     └─────────────────────────────────────┘                   │
│                                                                 │
│  Performance Optimization                                      │
│  ════════════════════════                                      │
│                                                                 │
│     • Connection Pooling (100-1000 connections)                │
│     • Batch Operations (50-100 nodes/batch)                    │
│     • Index Sharding (by type/status)                          │
│     • Event Stream Partitioning                                │
│     • Read Replicas for queries                                │
│     • Write-through caching                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Summary

These architecture diagrams illustrate:

1. **System Overview**: Complete platform architecture from sensors to storage
2. **Data Flow**: How data moves through the system
3. **Redis Schema**: Detailed storage structure
4. **Sensor Lifecycle**: Complete sensor operation flow
5. **Event Pipeline**: Event processing from source to subscribers
6. **Deployment**: Production deployment topology
7. **Security**: Multi-layer security architecture
8. **Scaling**: Strategies for handling thousands of nodes and sensors

The architecture is designed for:
- **High Performance**: Sub-millisecond operations with Redis
- **Scalability**: Horizontal scaling to 10K+ nodes
- **Reliability**: Event sourcing and atomic operations
- **Security**: Token-based auth with audit logging
- **Flexibility**: Multiple sensor types and client applications